"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(function(){jQuery(document).ready(function(i){function t(e){_classCallCheck(this,t),this.id=e.id,this.slug=e.slug,this.debug=e.debug,this.card_types=e.card_types,this.styles=e.styles,this.messages=window.sv_wc_payment_gateway_payment_form_params,i("form.checkout").length?this.handle_checkout_page():i("form#order_review").length?this.handle_pay_page():i("form#add_payment_method").length&&this.handle_add_payment_method_page()}return window.WC_Bambora_Payment_Form_Handler=(_createClass(t,[{key:"handle_checkout_page",value:function(){var e=this;return this.payment_form=i("form.checkout"),this.payment_ui_selector=".woocommerce-checkout-payment",i(document.body).on("updated_checkout",function(){return e.setup()}),i(document.body).on("updated_checkout",function(){return e.handle_saved_payment_methods()}),i(document.body).on("checkout_error",function(){return e.set_token(),e.unblock_ui()}),this.payment_form.on("checkout_place_order_"+this.id,function(){return e.verify_form()})}},{key:"handle_pay_page",value:function(){var e=this;return this.payment_form=i("form#order_review"),this.payment_ui_selector="#payment",this.handle_saved_payment_methods(),this.setup(),this.payment_form.submit(function(){return e.verify_form()})}},{key:"handle_add_payment_method_page",value:function(){var e=this;return this.payment_form=i("form#add_payment_method"),this.payment_ui_selector="#payment",this.setup(),this.payment_form.submit(function(){return e.verify_form()})}},{key:"handle_saved_payment_methods",value:function(){var n=this,e=i("div.js-wc-"+this.slug+"-new-payment-method-form");return i("input.js-wc-"+this.slug+"-payment-token").change(function(){return i("input.js-wc-"+n.slug+"-payment-token:checked").val()?e.slideUp(200):e.slideDown(200)}).change(),i("input#createaccount").change(function(e){var t=i("input.js-wc-"+n.slug+"-tokenize-payment-method").closest("p.form-row");return i(e.target).is(":checked")?(t.slideDown(),t.next().show()):(t.hide(),t.next().hide())}).change()}},{key:"setup",value:function(){var e,t,n,r=this,a="#wc-"+this.slug+"-account-number-hosted",s="#wc-"+this.slug+"-expiry-hosted",o="#wc-"+this.slug+"-csc-hosted";if(0===i(a+" iframe").length)return this.integration=customcheckout(),e={placeholder:i(a).data("placeholder"),brands:this.card_types,style:this.styles.card_number},n={placeholder:i(s).data("placeholder"),style:this.styles.expiry},t={placeholder:i(o).data("placeholder"),style:this.styles.cvv},this.hosted_inputs={card_number:this.integration.create("card-number",e),expiry:this.integration.create("expiry",n),cvv:this.integration.create("cvv",t)},this.hosted_inputs.card_number.mount(a),this.hosted_inputs.expiry.mount(s),this.hosted_inputs.cvv.mount(o),this.integration.on("brand",function(e){return r.on_card_type_change(e)}),this.integration.on("error",function(e){return r.on_field_error(e)}),this.integration.on("complete",function(e){return r.on_field_complete(e)})}},{key:"on_card_type_change",value:function(e){if(null!=e.brand)return i("#wc-"+this.slug+"-account-number-hosted").attr("class",function(e,t){return t.replace(/(^|\s)card-type-\S+/g,"")}),i("#wc-"+this.slug+"-account-number-hosted").addClass("card-type-"+e.brand),i("input[name=wc-"+this.slug+"-card-type]").val(e.brand)}},{key:"on_field_error",value:function(e){var t,n;if(null!=e.type&&null!=e.field){switch(e.type){case"CardNumberInvalid":n=this.messages.card_number_invalid;break;case"CvvNotSet":n=this.messages.cvv_missing;break;case"ExpiryIsInThePast":case"ExpiryIsNotSet":n=this.messages.card_exp_date_invalid;break;default:n=null!=e.message?e.message:null}switch(e.field){case"card-number":t=i("#wc-"+this.slug+"-account-number-hosted");break;case"expiry":t=i("#wc-"+this.slug+"-expiry-hosted");break;case"cvv":t=i("#wc-"+this.slug+"-csc-hosted")}return t.next(".bambora-hosted-error").remove(),n?t.after('<div class="bambora-hosted-error">'+n+"</div>"):void 0}}},{key:"on_field_complete",value:function(e){var t;if(null!=e.field){switch(e.field){case"card-number":t=i("#wc-"+this.slug+"-account-number-hosted");break;case"expiry":t=i("#wc-"+this.slug+"-expiry-hosted");break;case"cvv":t=i("#wc-"+this.slug+"-csc-hosted")}return t.next(".bambora-hosted-error").remove()}}},{key:"verify_form",value:function(){return!this.is_selected()||(!!this.has_token()||(!!this.using_profile()||(this.block_ui(),this.create_token(),!1)))}},{key:"create_token",value:function(){var t=this;return this.integration.createToken(function(e){return null!=e.token?(t.set_token(e),t.payment_form.submit()):(t.log(e.error.message,e),t.unblock_ui(),t.set_token(),i(".woocommerce-error, .woocommerce-message").remove(),t.payment_form.prepend('<p class="woocommerce-error">'+e.error.message+"</p>"),t.payment_form.removeClass("processing").unblock(),t.payment_form.find(".input-text, select").blur(),i("html, body").animate({scrollTop:t.payment_form.offset().top-100},1e3))})}},{key:"set_token",value:function(e){var t=0<arguments.length&&void 0!==e?e:{},n=null!=t.token?t.token:"",r=null!=t.expiryMonth?t.expiryMonth:"",a=null!=t.expiryYear?t.expiryYear:"",s=null!=t.last4?t.last4:"";return i("input[name=wc-"+this.slug+"-js-token]").val(n),i("input[name=wc-"+this.slug+"-account-number]").val(s),i("input[name=wc-"+this.slug+"-exp-month]").val(r),i("input[name=wc-"+this.slug+"-exp-year]").val(a)}},{key:"block_ui",value:function(){return i(this.payment_ui_selector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}},{key:"unblock_ui",value:function(){return i(this.payment_ui_selector).unblock()}},{key:"has_token",value:function(){return i("input[name=wc-"+this.slug+"-js-token]").val()}},{key:"using_profile",value:function(){return this.payment_form.find("input.js-wc-"+this.slug+"-payment-token:checked").val()}},{key:"is_selected",value:function(){return this.get_selected_gateway_id()===this.id}},{key:"get_selected_gateway_id",value:function(){return this.payment_form.find("input[name=payment_method]:checked").val()}},{key:"log",value:function(e,t){if(this.debug)return console.log("[Bambora] "+e),console.log(t)}}]),t),i(document.body).trigger("wc_bambora_payment_form_handler_loaded")})}).call(void 0);